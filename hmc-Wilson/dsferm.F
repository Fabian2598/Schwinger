C     ******************************************************************
      subroutine dsferm(akap, u, a, dsf)
C     ******************************************************************
C     **                    **                                        **
C     **  DSFERM            **  Based on GET_DSF by C.B. Lang         **
C     **                    **  (Modified by I. Hip, Nov 95)          **
C     ******************************************************************
C     ------------------------------------------------------------------
C     Program for determination of  d S_F(U) / d A
C     Wilson fermions (r = 1)
C     ------------------------------------------------------------------
C     Part of package:   hmc2dfu1
C     ------------------------------------------------------------------
C     Input variables:  akap, u, a = (M^+ M)^(-1) phi
C     ------------------------------------------------------------------
C     Output variables:  dsf(1:nsite,1:ndim)
C     ------------------------------------------------------------------
C     Remarks:   d S_F(U) / d U =
C                - (a, [(iU dM^+/dU)M + M^+(iU dM/dU)] a) =
C                    (* where  (a = (M^+ M)^(-1) phi) *)
C                = - 2 Re (a, (i U dM^+/dU)  M a) = (* b = M a *)
C                = - 2 Re (a, (i U dM^+/dU)  b)
C     ------------------------------------------------------------------
C     sigma_1 = ( 0, 1; 1, 0)
C     sigma_2 = ( 0,-i; i, 0)
C     sigma_3 = ( 1, 0; 0,-1)
C     ******************************************************************
      parameter (ndrc=2,ngrp=1,ndim=2)
      parameter (nsite=NTIME*NSPACE)
      parameter (nall=2*ndrc*ngrp*nsite)
C     ------------------------------------------------------------------
      real*8 u(2,nsite,ndim), a(2,ndrc,nsite), b(2,ndrc,nsite)
      real*8 dsf(nsite,ndim), akap, akap2
      integer ind(4,nsite)
C     ------------------------------------------------------------------
      common /index_arrays/ind
C     ------------------------------------------------------------------
      call mvec(a, b)
      akap2 = 2.0d0 * akap

      do i = 1, nsite
	    i1=ind(1,i)
	    i2=ind(2,i)
	    dsf(i,1) = -akap2 * (
     &    ((a(1,1,i) -a(1,2,i) )*(b(1,1,i1)-b(1,2,i1))
     &    +(a(2,1,i) -a(2,2,i) )*(b(2,1,i1)-b(2,2,i1))
     &    +(a(1,1,i1)+a(1,2,i1))*(b(1,1,i) +b(1,2,i) )
     &    +(a(2,1,i1)+a(2,2,i1))*(b(2,1,i) +b(2,2,i) ))*u(2,i,1)
     &    +((a(1,1,i) -a(1,2,i) )*(b(2,1,i1)-b(2,2,i1))
     &    -(a(2,1,i) -a(2,2,i) )*(b(1,1,i1)-b(1,2,i1))
     &    -(a(1,1,i1)+a(1,2,i1))*(b(2,1,i) +b(2,2,i) )
     &    +(a(2,1,i1)+a(2,2,i1))*(b(1,1,i) +b(1,2,i) ))*u(1,i,1) )
	    dsf(i,2) = -akap2 * (
     &    ((a(1,1,i) -a(2,2,i) )*(b(1,1,i2)-b(2,2,i2))
     &    +(a(1,2,i) +a(2,1,i) )*(b(2,1,i2)+b(1,2,i2))
     &    +(a(1,1,i2)+a(2,2,i2))*(b(1,1,i) +b(2,2,i) )
     &    -(a(1,2,i2)-a(2,1,i2))*(b(2,1,i) -b(1,2,i) ))*u(2,i,2)
     &    +((a(1,1,i) -a(2,2,i) )*(b(2,1,i2)+b(1,2,i2))
     &    -(a(1,2,i) +a(2,1,i) )*(b(1,1,i2)-b(2,2,i2))
     &    -(a(1,1,i2)+a(2,2,i2))*(b(2,1,i) -b(1,2,i) )
     &    -(a(1,2,i2)-a(2,1,i2))*(b(1,1,i) +b(2,2,i) ))*u(1,i,2) )
        end do
      end
